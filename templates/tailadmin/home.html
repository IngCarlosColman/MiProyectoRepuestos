{% extends "tailadmin/base.html" %}
{% load static %}
{% load leaflet_tags %}

{% block title %}
  BÃºsqueda | Auto Repuestos Paraguay
{% endblock %}

{% block page_name %}
  Buscador de Tiendas y Talleres
{% endblock %}

{% block content %}
<div class="space-y-6 p-4 md:p-6">
  <form action="" method="get" class="mb-6 flex items-center gap-2">
    <input
      type="text"
      name="q"
      placeholder="Buscar tienda o taller..."
      value="{{ query }}"
      class="flex-1 rounded-lg border border-gray-300 p-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
    />
    <button
      type="submit"
      class="rounded-lg bg-blue-600 px-4 py-2 text-white hover:bg-blue-700"
    >
      Buscar
    </button>
  </form>

  <div class="mb-6">
    {% leaflet_map "main_map" callback="map_init" %}
  </div>

  <div class="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-3">
    {% for branch in branches %}
      <div class="rounded-2xl border border-gray-200 bg-white p-5 sm:p-6">
        <h3 class="text-base font-medium text-gray-800">
          {{ branch.name }} (Sucursal)
        </h3>
        <p class="mt-2 text-gray-600">
          {{ branch.address }}
        </p>
        </div>
    {% empty %}
      <p>No se encontraron resultados.</p>
    {% endfor %}

    {% for professional in professionals %}
      <div class="rounded-2xl border border-gray-200 bg-white p-5 sm:p-6">
        <h3 class="text-base font-medium text-gray-800">
          {{ professional.workshop_name }} (Taller)
        </h3>
        <p class="mt-2 text-gray-600">
          {{ professional.address }}
        </p>
        </div>
    {% empty %}
      <p class="{% if not branches %}hidden{% endif %}">No se encontraron resultados.</p>
    {% endfor %}
  </div>
</div>
{% endblock %}

{% block head_extras %}
  {% leaflet_css %}
  {% leaflet_js %}
  <style>
    #main_map { height: 500px; width: 100%; }
  </style>
  <script>
    function map_init(map, options) {
      var branches = JSON.parse('{{ branches_geojson|safe }}');
      var professionals = JSON.parse('{{ professionals_geojson|safe }}');
      
      var branchesLayer = L.geoJSON(branches);
      var professionalsLayer = L.geoJSON(professionals);

      var allBounds = new L.LatLngBounds();
      if (branchesLayer.getBounds().isValid()) {
          allBounds.extend(branchesLayer.getBounds());
      }
      if (professionalsLayer.getBounds().isValid()) {
          allBounds.extend(professionalsLayer.getBounds());
      }

      if (allBounds.isValid()) {
          map.fitBounds(allBounds, {padding: [50, 50]});
      } else {
          map.setView([-25.26, -57.57], 8);
      }
      
      function addMarkers(geojson, map, popupContentCallback) {
        L.geoJSON(geojson, {
          onEachFeature: function(feature, layer) {
            layer.bindPopup(popupContentCallback(feature.properties));
          }
        }).addTo(map);
      }

      addMarkers(branches, map, function(props) {
        return "<h3>" + props.name + " (Sucursal)</h3><p>" + props.address + "</p>";
      });

      addMarkers(professionals, map, function(props) {
        return "<h3>" + props.workshop_name + " (Taller)</h3><p>" + props.address + "</p>";
      });
    }
  </script>
{% endblock %}