{% extends "tailadmin/base.html" %}
{% load static %}
{% load thumbnail %}

{% block title %}
  Resultados de Búsqueda
{% endblock %}

{% block page_name %}
  Resultados de Búsqueda para "{{ query }}"
{% endblock %}

{% block content %}
<div class="space-y-8 p-4 md:p-6">

    {% if search_geojson %}
    <section>
        <h2 class="text-xl font-semibold mb-4">Mapa de Resultados</h2>
        <div id="search-map" class="w-full h-96 rounded-lg shadow-md"></div>
    </section>
    {% endif %}

    {% if stores %}
    <section>
        <h2 class="text-xl font-semibold mb-4">Tiendas</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {% for store in stores %}
                <div class="bg-white p-6 rounded-lg shadow-md flex flex-col items-center text-center">
                    {% if store.logo %}
                        <img src="{% thumbnail store.logo 'logo_list' %}" alt="{{ store.name }} logo" class="w-24 h-24 rounded-full object-cover mb-4">
                    {% endif %}
                    <h3 class="text-lg font-semibold">{{ store.name }}</h3>
                    <p class="text-gray-600 mt-2">{{ store.address }}</p>
                    <a href="{% url 'store_detail' store.pk %}" class="mt-4 inline-block text-blue-600 hover:underline">Ver detalles</a>
                </div>
            {% endfor %}
        </div>
    </section>
    {% endif %}
    
    {% if branches %}
    <section>
        <h2 class="text-xl font-semibold mb-4">Sucursales</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {% for branch in branches %}
                <div class="bg-white p-6 rounded-lg shadow-md flex flex-col items-center text-center">
                    <h3 class="text-lg font-semibold">{{ branch.name }}</h3>
                    <p class="text-gray-600 mt-2">{{ branch.address }}</p>
                    <a href="{% url 'branch_detail' branch.pk %}" class="mt-4 inline-block text-blue-600 hover:underline">Ver detalles</a>
                </div>
            {% endfor %}
        </div>
    </section>
    {% endif %}

    {% if professionals %}
    <section>
        <h2 class="text-xl font-semibold mb-4">Talleres y Profesionales</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {% for professional in professionals %}
                <div class="bg-white p-6 rounded-lg shadow-md flex flex-col items-center text-center">
                    {% if professional.logo %}
                        <img src="{% thumbnail professional.logo 'logo_list' %}" alt="{{ professional.workshop_name }} logo" class="w-24 h-24 rounded-full object-cover mb-4">
                    {% endif %}
                    <h3 class="text-lg font-semibold">{{ professional.workshop_name }}</h3>
                    <p class="text-gray-600 mt-2">{{ professional.address }}</p>
                    <a href="{% url 'professional_detail' professional.pk %}" class="mt-4 inline-block text-blue-600 hover:underline">Ver detalles</a>
                </div>
            {% endfor %}
        </div>
    </section>
    {% endif %}
    
    {% if not stores and not branches and not professionals %}
    <p class="text-gray-500">No se encontraron resultados que coincidan con la búsqueda.</p>
    {% endif %}
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        var geojsonData = JSON.parse('{{ search_geojson|escapejs }}');
        
        if (geojsonData.features.length > 0) {
            var map = L.map('search-map').fitWorld();
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            var geojsonLayer = L.geoJSON(geojsonData, {
                onEachFeature: function(feature, layer) {
                    if (feature.properties && feature.properties.name && feature.properties.url) {
                        layer.bindPopup('<b>' + feature.properties.name + '</b><br>' + feature.properties.address + '<br><a href="' + feature.properties.url + '">Ver detalles</a>');
                    }
                }
            }).addTo(map);

            map.fitBounds(geojsonLayer.getBounds());
        }
    });
</script>
{% endblock %}